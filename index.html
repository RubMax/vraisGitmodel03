<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RubMax Serviços</title>

  <!-- Feuille de style principale -->
  <link rel="stylesheet" href="styles.css">
  <!-- Manifest PWA -->
  <link rel="manifest" href="https://raw.githubusercontent.com/RubMax/vraisGitmodel03/refs/heads/main/manifest.json">
  <!-- Icônes FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
  <!-- En-tête -->
  <header>
    <div id="headerOverlay" class="header-overlay">
      <img id="logo" class="logo" src="" alt="Logo">
      <div class="header-center">
        <h1 id="nomEntreprise"></h1>
        <p id="slogant"></p>
      </div>
    </div>
  </header>

  <!-- Menu latéral -->
  <nav class="sidebar" id="sidebarMenu">
    <a href="javascript:void(0)" class="active" onclick="filtrerParType('tous')">Menu</a>
  </nav>

  <!-- Contenu principal -->
  <div class="content-container">
    <div id="servicesContainer"></div>
    <footer>
      <p><span id="adresse"></span></p>
      <p>Tél: <span id="telfix"></span> | WhatsApp: <span id="whatsapp"></span></p>
      <p>Email: <span id="email"></span></p>
      <p>Domaine: <span id="domaine"></span></p>
    </footer>
  </div>

  <!-- Bouton d'installation PWA -->
  <button id="installAppBtn" style="display:none;position:fixed;bottom:30px;right:30px;padding:15px 22px;background:#83addc;color:#fff;border:none;border-radius:8px;font-size:1.2em;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.15);cursor:pointer;">
    Installer RubMax Serviços
  </button>

  <script>
    // --- Données & Variables
    let allServicesData = [];
    let groupedServices = {};
    const colors = ["#e74c3c", "#8e44ad", "#3498db", "#16a085", "#f39c12", "#d35400", "#2c3e50"];

    // --- Chargement des données : Apps Script OU GitHub
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof google !== "undefined") {
        google.script.run.withSuccessHandler(renderPage).getIndexData();
      } else {
        fetch('https://script.google.com/macros/s/AKfycbwJQO-cpguteF38PtytHKWWqZyoUR61tQoRz4Vyzh98vT4tcItVxZ00TOdcE9ihjmjj/exec?page=data')
  .then(res => res.json())
  .then(serviceArray => {
    const fakeEntete = {
      nomEntreprise: "RubMax",
      imgLogo: "",
      imgEntete: "",
      slogant: "Votre partenaire de confiance",
      adresse: "",
      telFix: "",
      whatsapp: "",
      email: "",
      domaine: ""
    };
    renderPage({ entete: fakeEntete, services: serviceArray });
  })


    // --- Affiche la page avec les données chargées
    function renderPage(data) {
      allServicesData = data.services;
      const entete = data.entete;

      document.getElementById("nomEntreprise").textContent = entete.nomEntreprise;
      document.getElementById("logo").src = entete.imgLogo;
      document.getElementById("slogant").textContent = entete.slogant;
      document.getElementById("headerOverlay").style.backgroundImage = `url('${entete.imgEntete}')`;
      document.getElementById("adresse").textContent = entete.adresse;
      document.getElementById("telfix").textContent = entete.telFix;
      document.getElementById("whatsapp").textContent = entete.whatsapp;
      document.getElementById("email").textContent = entete.email;
      document.getElementById("domaine").textContent = entete.domaine;

      groupedServices = {};
      const sidebar = document.getElementById("sidebarMenu");
      const typesAjoutes = new Set();
      let colorIndex = 0;

      data.services.forEach(service => {
        if (!groupedServices[service.type]) groupedServices[service.type] = [];
        groupedServices[service.type].push(service);

        if (!typesAjoutes.has(service.type)) {
          const link = document.createElement("a");
          link.href = "#";
          link.textContent = service.type;
          link.dataset.originalColor = colors[colorIndex % colors.length];
          link.style.backgroundColor = colors[colorIndex % colors.length];
          link.addEventListener("click", (e) => {
            e.preventDefault();
            filtrerParType(service.type);
          });
          sidebar.appendChild(link);
          typesAjoutes.add(service.type);
          colorIndex++;
        }
      });

      afficherArticles(data.services, "Menu");
    }

    // --- Affiche les articles/services
    function afficherArticles(liste, titre) {
      const container = document.getElementById("servicesContainer");
      container.innerHTML = "";

      const sectionTitle = document.createElement("div");
      sectionTitle.className = "section-title";
      sectionTitle.textContent = titre;
      container.appendChild(sectionTitle);

      const cards = document.createElement("div");
      cards.className = "cards-container";

      liste.forEach(service => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${service.img}" alt="${service.nom}">
          <div class="card-body">
            <div class="card-title">${service.nom}</div>
            <div class="card-desc">${service.description}</div>
            <div class="card-price">R$ ${service.prix}</div>
          </div>
        `;
        cards.appendChild(card);
      });

      container.appendChild(cards);
    }

    // --- Filtrage par catégorie/type
    function filtrerParType(type) {
      const links = document.querySelectorAll("#sidebarMenu a");
      links.forEach(link => {
        link.classList.remove("active");
        link.style.backgroundColor = link.dataset.originalColor;
        link.style.color = "white";
        if (link.textContent === type || (type === 'tous' && link.textContent === 'Menu')) {
          link.classList.add("active");
          link.style.backgroundColor = "white";
          link.style.color = "black";
        }
      });

      if (type === 'tous') {
        afficherArticles(allServicesData, "Menu");
      } else {
        afficherArticles(groupedServices[type] || [], type);
      }
    }

    // --- Service Worker de base
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
          self.addEventListener('install', e => self.skipWaiting());
          self.addEventListener('activate', e => {});
          self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));
        `], { type: 'application/javascript' })));
      });
    }

    // --- Bouton Installation PWA
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installAppBtn').style.display = 'block';
    });

    document.getElementById('installAppBtn').addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          if (choice.outcome === 'accepted') {
            document.getElementById('installAppBtn').style.display = 'none';
          }
          deferredPrompt = null;
        });
      }
    });
  </script>
</body>
</html>
